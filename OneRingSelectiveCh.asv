

function [h] = OneRingSelectiveCh(i, j, t, itr, N, fD, ta, R, teta, channel_profile);
%load channel_profile.am;


%ta = 50*1e-9;
%t = 1;

%R = 150; % tau_max = 1000 ns



phimax=2*pi*2/360;
alphaBS=2*pi*90/360;
alphaMS=2*pi*90/360;
alphav=2*pi*180/360;
SNR=10^(17/10);


if (itr == 1)
    deltaBS=1/2;
    deltaMS=1/2;
end

if (itr == 2)
        deltaBS=1;
        deltaMS=1;
end

if (itr == 3)
    deltaBS=30;
    deltaMS=3;
end




% kappa = 0; mu = 180;

phi1=[
    
   0.79842782905655   
   4.20967959599730
   2.82508985415071   
   0.20042948082869
   5.41586625521942   
   0.67654805739404
   3.86574280368874   
   0.40648265692220
   6.57608727492223   
   1.39906047548461
   5.36295464381639   
   3.04869439169898
   2.32481983227744   
   4.04990667013940
   4.57421579951588   
   0.72542133652998
   4.98222332488498   
   3.42176818696111
   3.53278395939635   
   4.05315346868276
   3.24417686835078   
   4.30507886609013
   0.55350356103150   
   0.07502613436925
   3.68237094279131   
   1.67216240545656
   0.17440447203220   
   5.07014778912524
   3.78971686009830   
   0.19449005561197
   2.85095816394955   
   2.64252963114655
   3.19090625718174   
   0.20581441653570
   0.03454765914250   
   1.60456045414354
   0.45976857115910   
   4.53421191396923
   5.23341405594682   
   3.83996467959221
   5.29733963690353   
   0.84922001778448
   2.74047186399103   
   4.12144077504691
   2.30620139643842   
   4.37972857290966
   0.45000686483031   
   5.31161694462099
   2.35297833401272   
   3.80323995922986
   3.52574155234227   
   1.30753692561640
   2.15303604006415   
   0.50321643492992
   5.16121762569044   
   4.34475664338237
   1.53395365129427   
   0.34325945367052
   3.17728728180925   
   5.67248050224838
   1.22928987652185   
   1.62641891869882
   1.37177617048132   
   0.24006321579091
   5.65631993639150   
   1.77820414315345
   4.20530440976713   
   0.75281173347532
   2.58955727832821   
   4.80777109827301
   3.27987608421661   
   3.35035116277462
   4.45149690658914   
   2.59910632426033
   5.20661747206811   
   4.83455353139637
   1.54172718000083   
   4.43272371913944
   5.12390912908099   
   4.26807246456881
];

phi2=[
    
  -3.00320709085293
  -0.83237841830576
   0.72727255592249
   1.38272139484274
   1.26666121574760
  -2.52262663593284
  -0.33652260251023
  -0.45302480809319
  -0.95620840061100
  -2.26474470696926
   1.08920327955138
   1.20500940009395
   1.38044676555068
  -0.14209813361519
   0.26237767330410
  -2.52804233402189
  -0.34358141291584
   1.31087330801838
   2.56747932564647
  -1.45263251660963
  -1.54957482230711
   2.18081084689481
  -1.74709405300981
   1.77800704744472
   2.63624452344481
  -1.66077669838419
  -1.55730928706547
  -3.18794922958075
  -2.24383837469772
   0.84753323656091
  -1.95505322494554
   1.84974232160826
  -2.06009522441790
  -2.04409629563776
   3.01207779364855
  -0.45376873703228
  -1.06372426968473
  -1.25265532499634
  -0.82465046850049
  -0.71333515557584
   0.55264749154306
  -2.54015655105183
  -2.98838984081165
  -0.34176583055296
   2.27166736204453
   2.69216547752869
  -1.54521470304572
  -2.03991075078807
   2.28205119742899
  -1.74320298721419
   0.84992937819552
   2.82451962041915
   0.97414795957226
   2.47910421434796
  -3.20272987714997
  -2.45381070082984
   1.84720442090746
  -0.45297420530359
   2.47265238849207
   1.47837157048991
   1.20703075398936
  -1.06649617336270
  -2.21189316716542
  -2.27185554493429
  -1.88698491217412
  -0.55543353239080
   2.08682771911275
  -0.14226218409562
   1.84879989299026
  -0.35057308450562
  -0.32301221244971
  -0.33934601998289
  -0.62663272831127
   2.54514064940172
  -3.22659640724209
  -1.35375006349645
  -2.99426563825564
   1.21027313645929
   0.85222547745850
   2.78934582884663
];


tau = time_delay(R,phi2);
tau_in_samples = round(tau/ta);


N_P = length(channel_profile);
sum=zeros(1,N_P);
h=zeros(1,N_P);
%count = zeros(1,N_P);
count=0;
if i==1
    if j==1
        for k = 1:N_P
            for n=1:N
                if (tau_in_samples(n)== (k-1))
                    an=exp(sqrt(-1)*pi*deltaBS*(cos(alphaBS)+phimax*sin(alphaBS)*sin(phi2(n))));
                    bn=exp(sqrt(-1)*pi*deltaMS*cos(phi2(n)-alphaMS));
                    fn=fD*cos(phi1(n)-alphav);
                    sum(k)=sum(k)+an*bn*exp(sqrt(-1)*(2*pi*fn*t+teta(n)));
                    count = count + 1;
                end
            end
            h(k)=channel_profile(k)*sum(k);
        end
        h=h./sqrt(count);
    elseif j==2
        for k = 1:N_P
            for n=1:N
                if (tau_in_samples(n)== (k-1))
                    an=exp(sqrt(-1)*pi*deltaBS*(cos(alphaBS)+phimax*sin(alphaBS)*sin(phi2(n))));
                    bn=exp(sqrt(-1)*pi*deltaMS*cos(phi2(n)-alphaMS));
                    fn=fD*cos(phi1(n)-alphav);
                    sum(k)=sum(k)+conj(an)*bn*exp(sqrt(-1)*(2*pi*fn*t+teta(n)));
                    count = count + 1;
                end
            end
            h(k)=channel_profile(k)*sum(k)/sqrt(count(k));
        end
    end    
elseif i==2
    if j==1
        
        for k = 1:N_P
            for n=1:N
                if (tau_in_samples(n)== (k-1))
                    an=exp(sqrt(-1)*pi*deltaBS*(cos(alphaBS)+phimax*sin(alphaBS)*sin(phi2(n))));
                    bn=exp(sqrt(-1)*pi*deltaMS*cos(phi2(n)-alphaMS));
                    fn=fD*cos(phi1(n)-alphav);
                    sum(k)=sum(k)+an*conj(bn)*exp(sqrt(-1)*(2*pi*fn*t+teta(n)));
                    count(k) = count(k) +1;
                end
            end
            h(k)=channel_profile(k)*sum(k)/sqrt(count(k));
        end
            
        
        
    elseif j==2
        for k = 1:N_P
            for n=1:N
                if (tau_in_samples(n)== (k-1))
                    an=exp(sqrt(-1)*pi*deltaBS*(cos(alphaBS)+phimax*sin(alphaBS)*sin(phi2(n))));
                    bn=exp(sqrt(-1)*pi*deltaMS*cos(phi2(n)-alphaMS));
                    fn=fD*cos(phi1(n)-alphav);
                    sum(k)=sum(k)+conj(an)*conj(bn)*exp(sqrt(-1)*(2*pi*fn*t+teta(n)));
                    count(k) = count(k) +1;
                end
            end
            h(k)=channel_profile(k)*sum(k)/sqrt(count(k));            
        end     
        
    end
end   